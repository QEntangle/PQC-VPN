# strongSwan configuration for PQC VPN Spoke (Client)
# /etc/strongswan.conf

strongswan {
    # Load additional plugins
    load_modular = yes
    
    # Plugin directory
    plugins {
        include /etc/strongswan.d/charon/*.conf
    }
    
    # Main daemon configuration
    charon {
        # Number of worker threads (fewer for clients)
        threads = 4
        
        # Enable file logging
        filelog {
            /var/log/strongswan.log {
                # Log level: -1=silent, 0=audit, 1=control, 2=diag, 3=raw, 4=debug
                default = 1
                append = no
                flush_line = yes
                time_format = %b %e %T
            }
            stderr {
                ike = 1
                knl = 2
                cfg = 1
            }
        }
        
        # System logging
        syslog {
            identifier = charon
            daemon {
                default = 1
            }
            auth {
                default = 1
            }
        }
        
        # Network settings
        network {
            # Enable IP forwarding (for routing)
            ip_forwarding = yes
            
            # Ignore redirects
            ignore_redirects = yes
            
            # Accept source routing
            accept_source_routing = no
            
            # Enable NAT traversal
            nat_traversal = yes
        }
        
        # Plugin configuration
        plugins {
            # X.509 certificate plugin
            x509 {
                # Enable certificate validation
                enforce_critical = yes
            }
            
            # Revocation checking (relaxed for clients)
            revocation {
                enable_crl = no
                enable_ocsp = no
            }
            
            # Random number generation
            random {
                urandom = /dev/urandom
                random = /dev/random
                strong_random = yes
            }
            
            # Socket configuration
            socket-default {
                # Use default port 500 for IKE
                port = 500
                # Use port 4500 for NAT traversal
                port_nat_t = 4500
                
                # Enable UDP encapsulation
                fwmark = !0x%mark
            }
            
            # Kernel interface
            kernel-netlink {
                # Disable hardware offloading for compatibility
                hw_offload = no
                
                # Buffer sizes
                buflen = 1500
                timeout = 0
                
                # Policy updates
                policy_update = yes
                
                # Enable roaming support
                roam_events = yes
                
                # Install routes automatically
                install_routes = yes
            }
            
            # Certificate validation
            constraints {
                # Load certificate constraints
                load = yes
            }
            
            # Post-Quantum Cryptography plugins
            openssl {
                # Enable OpenSSL for PQC algorithms
                load = yes
                
                # Disable FIPS mode for client compatibility
                fips_mode = no
                
                # Engine configuration
                engine = yes
            }
            
            # PQC algorithm support
            botan {
                # Enable Botan for additional PQC support
                load = yes
            }
            
            # Memory management
            gcm {
                # Enable AES-GCM mode
                load = yes
            }
            
            # Curve25519 support
            curve25519 {
                load = yes
            }
            
            # ChaCha20/Poly1305 support
            chapoly {
                load = yes
            }
            
            # Network manager integration (enable for desktop clients)
            networkmanager {
                load = yes
            }
            
            # Unity extensions for Cisco compatibility
            unity {
                load = yes
            }
            
            # XAUTH support
            xauth-generic {
                load = yes
            }
            
            # EAP methods
            eap-identity {
                load = yes
            }
            
            eap-mschapv2 {
                load = yes
            }
            
            eap-tls {
                load = yes
            }
            
            # Dead peer detection (aggressive for roaming clients)
            dpd {
                delay = 30s
                timeout = 120s
                action = restart
            }
            
            # Disable server-only features
            ha {
                load = no
            }
            
            sql {
                load = no
            }
            
            pkcs11 {
                load = no
            }
            
            tpm {
                load = no
            }
            
            # Enable connection tracking
            conntrack {
                load = yes
            }
            
            # Enable duplicate detection
            duplicheck {
                load = yes
            }
            
            # Enable stroke interface
            stroke {
                load = yes
            }
            
            # Enable updown script support
            updown {
                load = yes
            }
            
            # Enable DHCP support
            dhcp {
                load = yes
            }
            
            # Enable resolve plugin for DNS
            resolve {
                load = yes
            }
            
            # Enable attr plugin for attribute assignment
            attr {
                load = yes
            }
            
            # Enable counters
            counters {
                load = yes
            }
        }
        
        # DNS configuration (will be overridden by VPN)
        dns1 = 8.8.8.8
        dns2 = 1.1.1.1
        
        # Multiple authentication rounds
        multiple_authentication = no
        
        # Hash and URL encoding
        hash_and_url = no
        
        # Cookie threshold (lower for clients)
        cookie_threshold = 10
        
        # Retransmission settings (aggressive for mobile clients)
        retransmit_tries = 5
        retransmit_timeout = 2.0
        retransmit_base = 1.5
        retransmit_jitter = 0
        retransmit_limit = 0
        
        # Fragment size (conservative for mobile networks)
        fragment_size = 1024
        
        # Maximum number of half-open connections (low for clients)
        max_concurrent_half_open = 10
        
        # Block threshold
        block_threshold = 3
        
        # Close threshold
        close_ike_on_child_failure = yes
        
        # Integrity check
        integrity_test = no
        
        # Process routing priority
        priority_boost = {
            high = 1
            medium = 0
            low = 0
        }
        
        # Client-specific settings
        ignore_acquire_ts = no
        install_routes = yes
        install_virtual_ip = yes
        keep_alive = 30s
        max_redirects = 3
        prefer_configured_proposals = yes
        prefer_temporary_addrs = no
        process_route = yes
        receive_delay = 0
        send_delay = 0
        send_vendor_id = no
        signature_authentication = yes
        strict_crl_policy = no
        trust_router_certs = yes
        mobike = yes
        user_certificate = yes
        
        # Enable connection migration for roaming
        migrate_on_update = yes
        
        # Enable connection rekeying
        rekey_connections = yes
        
        # Connection timeout
        half_open_timeout = 30s
        
        # IKE timeout
        ike_timeout = 30s
    }
    
    # Plugin loader configuration
    load_modular = yes
    
    # Include additional configuration files
    include /etc/strongswan.d/*.conf
    
    # Starter configuration (legacy)
    starter {
        # Load connections at startup
        load_warning = yes
        
        # Configuration file
        config_file = /etc/ipsec.conf
        
        # Secrets file
        secrets_file = /etc/ipsec.secrets
    }
}

# Legacy pluto configuration (disabled)
pluto {
}