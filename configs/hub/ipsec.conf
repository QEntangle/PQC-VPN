# strongSwan IPsec configuration for PQC VPN Hub
# Enhanced version with PKI+PSK hybrid authentication and latest PQC algorithms
# /etc/ipsec.conf

config setup
    # Enhanced logging with PQC-specific debug
    charondebug="ike 4, knl 4, cfg 4, net 4, asn 4, enc 4, lib 4, esp 4, tls 4, tnc 4, imc 4, imv 4, pts 4, mgr 4, job 4"
    
    # Use system crypto plugins including PQC
    load_modular = yes
    
    # Load additional plugins for PQC and advanced features
    load = random nonce aes des sha1 sha2 sha3 md5 mgf1 fips_prf gmp x509 revocation constraints acert pubkey pkcs1 pkcs7 pkcs8 pkcs12 pgp dnskey sshkey pem openssl gcrypt af_alg farp stroke kernel-netlink resolve socket-default connmark forecast updown eap-identity eap-aka eap-md5 eap-gtc eap-mschapv2 eap-dynamic eap-radius eap-tls eap-ttls eap-peap xauth-generic xauth-eap xauth-pam xauth-noauth dhcp whitelist lookip error-notify certexpiry led addrblock unity
    
    # Disable pluto (IKEv1)
    plutostart = no
    
    # Enhanced connection handling
    uniqueids = no
    strictcrlpolicy = no
    
    # Performance tuning for enterprise deployment
    threads = 16
    
    # Certificate validation settings
    send_vendor_id = yes
    send_cert = ifasked

# Default connection template with latest PQC algorithms
conn %default
    # IKE version (v2 only for PQC support)
    keyexchange = ikev2
    
    # Enhanced PQC algorithm suite (NIST Round 4 + latest)
    # Primary: ML-KEM (Kyber) + ML-DSA (Dilithium) 
    ike = aes256gcm16-sha512-kyber1024-dilithium5,aes256gcm16-sha384-kyber768-dilithium3,aes128gcm16-sha256-kyber512-dilithium2
    esp = aes256gcm16-sha512-kyber1024,aes256gcm16-sha384-kyber768,aes128gcm16-sha256-kyber512
    
    # Fallback to classical algorithms for compatibility
    also = %compat
    
    # Certificate validation
    leftca = ca-cert.pem
    rightca = ca-cert.pem
    
    # Security parameters
    dpdaction = restart
    dpddelay = 30s
    dpdtimeout = 150s
    
    # Enhanced encryption settings
    forceencaps = yes
    fragmentation = yes
    rekey = yes
    
    # Connection settings
    auto = add
    type = tunnel
    
    # Perfect Forward Secrecy (mandatory)
    pfs = yes
    
    # Enhanced lifetime settings for PQC
    ikelifetime = 4h
    keylife = 30m
    margintime = 9m
    rekeyfuzz = 100%
    
    # Compression and optimization
    compress = yes
    
    # MOBIKE for seamless roaming
    mobike = yes
    
    # Enhanced dead peer detection
    closeaction = restart
    
    # Mark connections for advanced routing
    mark = %unique

# Compatibility fallback connection
conn %compat
    ike = aes256gcm16-sha512-ecp384,aes256-sha512-modp4096,aes128-sha256-modp2048
    esp = aes256gcm16-ecp384,aes256-sha512,aes128-sha256

# Hub-to-spoke PKI authentication (primary method)
conn hub-spoke-pki
    # Inherit default settings
    also = %default
    
    # Authentication method: PKI with PQC certificates
    authby = pubkey
    
    # Hub configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftid = "C=US, O=PQC-VPN, CN=hub.pqc-vpn.local"
    leftcert = hub-cert.pem
    leftkey = hub-key.pem
    leftfirewall = yes
    
    # Spoke configuration (dynamic)
    right = %any
    rightsubnet = 10.10.0.0/0
    
    # Connection settings
    auto = add
    type = tunnel
    
    # Enable spoke-to-spoke communication
    mark = 42

# Hub-to-spoke PSK authentication (alternative method)
conn hub-spoke-psk
    # Inherit default settings
    also = %default
    
    # Authentication method: Pre-Shared Key
    authby = psk
    
    # Hub configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftid = hub.pqc-vpn.local
    leftfirewall = yes
    
    # Spoke configuration (dynamic)
    right = %any
    rightsubnet = 10.10.0.0/0
    rightid = %any
    
    # Connection settings
    auto = add
    type = tunnel
    
    # Enable spoke-to-spoke communication
    mark = 43

# Hybrid PKI+PSK authentication (enterprise method)
conn hub-spoke-hybrid
    # Inherit default settings
    also = %default
    
    # Hybrid authentication: PKI + PSK for enhanced security
    authby = pubkey
    
    # Hub configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftid = "C=US, O=PQC-VPN, CN=hub.pqc-vpn.local"
    leftcert = hub-cert.pem
    leftkey = hub-key.pem
    leftfirewall = yes
    
    # Spoke configuration (dynamic)
    right = %any
    rightsubnet = 10.10.0.0/0
    
    # Additional PSK for enhanced security
    keyid = %any
    
    # Connection settings
    auto = add
    type = tunnel
    
    # Enable spoke-to-spoke communication
    mark = 44

# Site-to-site VPN connection template
conn site-to-site
    also = %default
    authby = pubkey
    
    # Left site (hub)
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftid = "C=US, O=PQC-VPN, CN=hub.pqc-vpn.local"
    leftcert = hub-cert.pem
    leftkey = hub-key.pem
    
    # Right site (remote)
    right = %any
    rightsubnet = 192.168.0.0/16
    rightid = %any
    
    # Connection settings
    auto = start
    type = tunnel
    dpdaction = restart

# Road warrior connection (mobile clients)
conn roadwarrior
    also = %default
    authby = pubkey
    
    # Hub configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16,0.0.0.0/0
    leftid = "C=US, O=PQC-VPN, CN=hub.pqc-vpn.local"
    leftcert = hub-cert.pem
    leftkey = hub-key.pem
    leftfirewall = yes
    
    # Mobile client configuration
    right = %any
    rightsubnet = 10.10.0.0/0
    rightdns = 8.8.8.8,1.1.1.1
    
    # Enhanced mobile settings
    mobike = yes
    closeaction = restart
    dpdaction = restart
    
    # Connection settings
    auto = add
    type = tunnel

# High-availability cluster connection
conn ha-cluster
    also = %default
    authby = pubkey
    
    # Cluster configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftid = "C=US, O=PQC-VPN, CN=hub-cluster.pqc-vpn.local"
    leftcert = cluster-cert.pem
    leftkey = cluster-key.pem
    
    # Peer cluster node
    right = %any
    rightsubnet = 10.10.0.0/16
    rightid = "C=US, O=PQC-VPN, CN=hub-cluster.pqc-vpn.local"
    
    # Cluster-specific settings
    auto = start
    type = tunnel
    mark = 100

# EAP authentication for RADIUS integration
conn hub-spoke-eap
    also = %default
    
    # EAP authentication
    authby = eap
    eap_identity = %identity
    
    # Hub configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftauth = pubkey
    leftid = "C=US, O=PQC-VPN, CN=hub.pqc-vpn.local"
    leftcert = hub-cert.pem
    leftkey = hub-key.pem
    leftfirewall = yes
    
    # Spoke configuration
    right = %any
    rightsubnet = 10.10.0.0/0
    rightauth = eap-mschapv2
    rightsendcert = never
    
    # Connection settings
    auto = add
    type = tunnel

# Load balancing connection template
conn hub-spoke-lb
    also = %default
    authby = pubkey
    
    # Load balancer configuration
    left = %defaultroute
    leftsubnet = 10.10.0.0/16
    leftid = "C=US, O=PQC-VPN, CN=lb.pqc-vpn.local"
    leftcert = lb-cert.pem
    leftkey = lb-key.pem
    leftfirewall = yes
    
    # Spoke configuration
    right = %any
    rightsubnet = 10.10.0.0/0
    
    # Load balancing specific settings
    mark = 200
    
    # Connection settings
    auto = add
    type = tunnel

# Certificate revocation and OCSP
conn crl-ocsp
    also = %default
    crluri = http://hub.pqc-vpn.local/crl.pem
    ocspuri = http://hub.pqc-vpn.local:8080/ocsp
    strictcrlpolicy = yes

# Individual spoke connections (dynamically generated)
# Template format for add-spoke-user.sh script
include /etc/ipsec.d/conf.d/*.conf

# Performance monitoring connection
conn monitor
    also = %default
    authby = pubkey
    
    # Monitoring server
    left = %defaultroute
    leftsubnet = 10.10.255.0/24
    leftid = "C=US, O=PQC-VPN, CN=monitor.pqc-vpn.local"
    leftcert = monitor-cert.pem
    leftkey = monitor-key.pem
    
    # Connection settings
    auto = ignore
    type = tunnel
